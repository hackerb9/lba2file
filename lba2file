#!/bin/bash -x

# lba2file: Given an LBA number and a drive in /dev/, print which
# filename(s), if any, use that sector.

# This is the opposite of `hdparm --fibmap /foo/bar`

# B9 Feburary 2019

if [[ "$1" == "-b" ]]; then
    BYTESFLAG=Byte
    shift
fi

if [[ $# -lt 2 ]]; then
    echo "Usage: lba2file  [-b]   /dev/sdX   <sector number ...>"
    echo "	-b: Use byte address instead of sector"
    exit 1
fi

drive=$1
shift

# Now all remaining args in "$@" are sector addresses.
addresses="$@"

for partition in ${drive}?; do
    info=$(udisks --show-info $partition)
    if ! e2blocksize=$(tune2fs -l $partition 2>/dev/null |
			      grep '^Block size' | egrep -o '[0-9]+'); then
	continue		# Not an Ext2/3/4 partition
    fi
    offset=$(grep '^    offset:' <<< "$info" | egrep -o '[0-9]+')
    partitionsize=$(grep '^  size:' <<< "$info" | egrep -o '[0-9]+')
    diskblocksize=$(grep '^  block size:' <<< "$info" | egrep -o '[0-9]+')


    # Typically: e2blocksize==4096, diskblocksize==512
    # Example: offset=1048576, partitionsize=640133980160
    set - $addresses
    if [[ -z "$BYTESFLAG" ]]; then
	set - $(for lba; do
		    echo $((lba * diskblocksize))
		done)
    fi
    set - $(for byteaddress; do
		if [[ $byteaddress -lt $offset ||
			    $byteaddress -ge $((offset+partitionsize)) ]]; then
		    echo "$byteaddress not in $partition" >&2
		    continue
		else
		    echo $byteaddress
		fi
	    done)

    set - $(for byteaddress; do
		echo $(( (byteaddress-offset) / e2blocksize))
	    done)

    Sector=${BYTESFLAG:-Sector}

    set - $(debugfs -R "icheck $*" $partition 2>/dev/null |
		   tail -n +2 | cut -f2)

    set - $(for inode; do
		if [[ "$inode" && "$inode" != "<block not found>" ]]; then
		    echo $inode
		    echo "$Sector is used by inode $inode" >&2
		else
		    echo "$Sector is not in use." >&2
		fi
	    done)

    echo "Searching for filename(s)..."
    debugfs -R "ncheck $*" $partition 
done
